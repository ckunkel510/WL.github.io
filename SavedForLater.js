
setTimeout(() =>{
(function() {

  const SFL_NAME = "Saved For Later";
  const SFL_DESC = "Saved For Later";
  const BASE = location.origin + "/";




  // Inject container HTML into DOM
  const container = document.createElement("div");
  container.id = "savedForLater";
  container.style.display = "none";
  container.innerHTML = `
    <div id="sflHeader">
      <span>Saved For Later</span>
      <span class="sflCount" id="sflCount"></span>
    </div>
    <div id="sflBody">
      <div id="sflLoading">Loading your saved items…</div>
      <div id="sflList" style="display:none;"></div>
      <div id="sflEmpty" style="display:none;">No items saved for later.</div>
    </div>
  `;
  const mainContents = document.querySelector('.mainContents');
if (mainContents && mainContents.parentNode) {
  mainContents.parentNode.insertBefore(container, mainContents.nextSibling);
  console.log("[SFL] Injected after .mainContents");
} else {
  console.warn("[SFL] .mainContents not found, appending to body");
  document.body.appendChild(container);
}

  console.log("[SFL] Injected Saved For Later HTML container");

  // Utility functions
  async function fetchHtml(url, options = {}) {
    console.log("[SFL] Fetching HTML from:", url);
    const res = await fetch(url, { credentials: "include", ...options });
    if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    const text = await res.text();
    const doc = new DOMParser().parseFromString(text, "text/html");
    return { text, doc };
  }

  function getHiddenFields(doc) {
    const fields = {};
    doc.querySelectorAll('input[type="hidden"]').forEach(inp => {
      if (inp.name) fields[inp.name] = inp.value || "";
    });
    return fields;
  }

  function toFormData(obj) {
    const fd = new FormData();
    Object.entries(obj).forEach(([k, v]) => fd.append(k, v));
    return fd;
  }

  function $(sel, root = document) {
    return root.querySelector(sel);
  }

  function $all(sel, root = document) {
    return Array.from(root.querySelectorAll(sel));
  }

  function ensureSflContainer() {
    const el = document.getElementById("savedForLater");
    if (el) el.style.display = "block";
    return el;
  }

  function setLoading(msg = "Loading your saved items…") {
    console.log("[SFL] setLoading:", msg);
    $("#sflLoading").style.display = "block";
    $("#sflLoading").textContent = msg;
    $("#sflList").style.display = "none";
    $("#sflEmpty").style.display = "none";
  }

  function setEmpty() {
    console.log("[SFL] No items found");
    $("#sflLoading").style.display = "none";
    $("#sflList").style.display = "none";
    $("#sflEmpty").style.display = "block";
    $("#sflCount").textContent = "(0)";
  }

  function setListCount(n) {
    console.log(`[SFL] Found ${n} items`);
    $("#sflCount").textContent = `(${n})`;
  }

  // --------- Step 0: must be signed in
  const wlUserId = (typeof localStorage !== "undefined") ? localStorage.getItem("wl_user_id") : null;
  console.log("[SFL] wl_user_id =", wlUserId);
  if (!wlUserId) {
    console.log("[SFL] Not signed in — skipping");
    return;
  }

  ensureSflContainer();
  setLoading();

  // --------- Step 1: Find or create the Saved For Later quicklist
  async function findSavedForLaterList() {
    console.log("[SFL] Searching for existing quicklist...");
    const { doc } = await fetchHtml(BASE + "Quicklists_R.aspx");
    const table = doc.querySelector("table.rgMasterTable");
    if (!table) return { exists: false };

    let sflRow = null;
    const rows = $all("tbody > tr", table);
    for (const tr of rows) {
      const anchor = tr.querySelector('td a[href*="Quicklists_R.aspx"]');
      if (!anchor) continue;
      if (anchor.textContent.trim().toLowerCase() === SFL_NAME.toLowerCase()) {
        sflRow = { tr, anchor };
        break;
      }
    }

    if (sflRow) {
      const href = new URL(sflRow.anchor.getAttribute("href"), BASE).toString();
      console.log("[SFL] Found existing Saved For Later quicklist:", href);
      return { exists: true, detailUrl: href };
    }

    console.log("[SFL] Quicklist not found — will create new");
    return { exists: false };
  }

  async function createSavedForLaterList() {
    console.log("[SFL] Creating Saved For Later quicklist…");
    const addUrl = BASE + "Quicklists_R.aspx?addNew=1";
    const { doc } = await fetchHtml(addUrl);

    const hidden = getHiddenFields(doc);
    hidden["ctl00$PageBody$EditQuicklistName"] = SFL_NAME;
    hidden["ctl00$PageBody$EditQuicklistDescription"] = SFL_DESC;

    const defaultSel = $("#ctl00_PageBody_EditDefaultQuicklistDropdown", doc);
    const val = defaultSel ? (defaultSel.value || "no") : "no";
    hidden["ctl00$PageBody$EditDefaultQuicklistDropdown"] = val;

    // Simulate Save button click via __doPostBack
    hidden["__EVENTTARGET"] = "ctl00$PageBody$SaveQuickListButton";
    hidden["__EVENTARGUMENT"] = "";

    console.log("[SFL] Submitting quicklist creation form with postback to SaveQuickListButton");
    const fd = toFormData(hidden);
    const res = await fetch(addUrl, {
      method: "POST",
      credentials: "include",
      body: fd
    });

    if (!res.ok) throw new Error("Quicklist creation POST failed.");

    const found = await findSavedForLaterList();
    if (!found.exists) throw new Error("Quicklist was not created as expected.");
    return found.detailUrl;
  }

  // --------- Step 2: Resolve detail URL for SFL
  async function ensureSflDetailUrl() {
  console.log("[SFL] Locating Saved For Later Quicklist via Quicklists_R.aspx...");
  sessionStorage.removeItem("sfl_detail_url"); // always re-check

  const found = await findSavedForLaterList(); // loads Quicklists_R.aspx
  if (found.exists && found.detailUrl) {
    console.log("[SFL] Found valid Quicklist detail URL:", found.detailUrl);
    const fixedUrl = found.detailUrl.replace("QuicklistDetails.aspx", "Quicklists_R.aspx");
sessionStorage.setItem("sfl_detail_url", fixedUrl);
console.log("[SFL] Saved corrected detail URL:", fixedUrl);

    return found.detailUrl;
  }

  console.log("[SFL] Not found, creating new Saved For Later list...");
  const createdUrl = await createSavedForLaterList();
  sessionStorage.setItem("sfl_detail_url", createdUrl);
  return createdUrl;
}


  // --------- Step 3: Load items
 function parseSflItems(detailDoc) {
  console.log("[SFL] Parsing Quicklist detail page...");

  // Find the outer grid div (fallback to .RadGrid or .rgMasterTable)
  let grid = detailDoc.querySelector(".RadGrid") || detailDoc.querySelector("table.rgMasterTable");
  if (!grid) {
    console.error("[SFL] Grid container not found");
    return [];
  }

  // Ensure we have the actual table
  let table = grid.tagName === "TABLE" ? grid : grid.querySelector("table.rgMasterTable");
  if (!table) {
    console.error("[SFL] .rgMasterTable not found inside grid container");
    return [];
  }

  const rows = table.querySelectorAll("tr.rgRow, tr.rgAltRow");
  console.log(`[SFL] Found ${rows.length} row(s) in Quicklist table`);

  const items = [];

  rows.forEach((tr, i) => {
    const tds = Array.from(tr.querySelectorAll("td"));
    if (tds.length < 5) {
      console.warn(`[SFL] Skipping row ${i} — only ${tds.length} td cells`);
      return;
    }

    const a = tds[0].querySelector("a[href*='ProductDetail.aspx']");
    const productHref = a?.getAttribute("href") || null;
    const productCode = a?.textContent.trim() || "";
    const description = tds[1].textContent.trim();
    const price = tds[2].textContent.trim();
    const per = tds[3].textContent.trim();

    // 🔍 Find delete anchor and extract EVENTTARGET
    const deleteAnchor = tr.querySelector("a[id*='DeleteQuicklistLineButtonX']");
    let eventTarget = null;

    if (deleteAnchor) {
      const href = deleteAnchor.getAttribute("href") || "";
      const match = href.match(/__doPostBack\('([^']+)'/);
      if (match) {
        eventTarget = match[1];
        console.log(`[SFL] Row ${i}: Found delete __EVENTTARGET: ${eventTarget}`);
      } else {
        console.warn(`[SFL] Row ${i}: Failed to extract __EVENTTARGET from href`);
      }
    } else {
      console.warn(`[SFL] Row ${i}: No delete anchor found`);
    }

    console.log(`[SFL] Row ${i}: ${productCode} | ${description} | ${price} | ${per}`);

    items.push({
      productHref,
      productCode,
      description,
      price,
      per,
      eventTarget // 💡 used later to remove item
    });
  });

  return items;
}






  async function loadSflItems() {
  const detailUrl = await ensureSflDetailUrl();
  const { doc } = await fetchHtml(detailUrl);
  const items = parseSflItems(doc);
  return { detailUrl, items, doc };
}

  // --------- Step 4: Render
  function pidFromHref(href) {
    try {
      const u = new URL(href, BASE);
      return u.searchParams.get("pid");
    } catch (e) {
      return null;
    }
  }

  function productImageUrlFromPid(pid) {
    return "https://images-woodsonlumber.sirv.com/Other%20Website%20Images/placeholder.png";
  }

  function renderSflList(items) {
    const list = $("#sflList");
    list.innerHTML = "";

    if (!items.length) {
      setEmpty();
      return;
    }

    items.forEach(item => {
      const pid = item.productHref ? pidFromHref(item.productHref) : null;
      const img = productImageUrlFromPid(pid);

      const row = document.createElement("div");
      row.className = "sflRow";
      row.innerHTML = `
        <img class="sflImg" src="${img}" alt="">
        <div>
          <div class="sflTitle">${item.productCode || ""}</div>
          <div class="sflDesc">${item.description || ""}</div>
        </div>
        <div class="sflPrice">${item.price || ""}</div>
        <div class="sflPer">${item.per || ""}</div>
        <div class="sflActions">
          <button class="sflBtn js-sfl-add" data-pid="${pid || ""}" data-code="${item.productCode || ""}">Add to Cart</button>
        </div>
      `;
      row.dataset.eventTarget = item.eventTarget || "";
      row.dataset.pid = pid || "";
      row.dataset.code = item.productCode || "";
      list.appendChild(row);
    });

    setListCount(items.length);
    $("#sflLoading").style.display = "none";
    $("#sflEmpty").style.display = "none";
    list.style.display = "block";
  }

  // --------- Init
  (async function initSfl() {
   try {
      console.log("[SFL] Initializing...");
      const { items } = await loadSflItems();
      renderSflList(items);
      console.log("[SFL] Done.");
    } catch (err) {
      console.error("[SFL] Error during init:", err);
      setEmpty();
    }
})();
})();






























(function(){
  const BASE = location.origin + "/";

  function $(sel, root=document) { return root.querySelector(sel); }
  function $all(sel, root=document) { return Array.from(root.querySelectorAll(sel)); }

  async function fetchHtml(url, options = {}) {
    const res = await fetch(url, { credentials: "include", ...options });
    if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    const text = await res.text();
    const doc = new DOMParser().parseFromString(text, "text/html");
    return { text, doc };
  }
  function getHiddenFields(doc) {
    const fields = {};
    doc.querySelectorAll('input[type="hidden"]').forEach(inp => {
      if (inp.name) fields[inp.name] = inp.value || "";
    });
    return fields;
  }
  function toFormData(obj) {
    const fd = new FormData();
    Object.entries(obj).forEach(([k, v]) => fd.append(k, v));
    return fd;
  }

  async function addPidToCart(pid, qty = 1) {
  if (!pid) throw new Error("PID required to add to cart.");
  const pdpUrl = BASE + "ProductDetail.aspx?pid=" + encodeURIComponent(pid);
  console.log("[SFL] Loading PDP:", pdpUrl);
  const { doc } = await fetchHtml(pdpUrl);

  const hidden = getHiddenFields(doc);

  // Try to find quantity input (optional)
  let qtyInput = doc.querySelector('input[name*="qty"]');
  if (qtyInput && qtyInput.name) {
    hidden[qtyInput.name] = String(qty);
    console.log("[SFL] Setting quantity:", qtyInput.name, "=", qty);
  }

  // Auto-detect Add to Cart link first
  let eventTarget = null;
  const atcLink = doc.querySelector('a[href^="javascript:__doPostBack"][id*="AddProductButton"]');
  if (atcLink) {
    const href = atcLink.getAttribute("href");
    const m = href.match(/__doPostBack\('([^']+)'/);
    if (m) eventTarget = m[1];
    console.log("[SFL] Auto-detected Add to Cart event target:", eventTarget);
  }

  // Fallback if not found
  if (!eventTarget) {
    eventTarget = "ctl00$PageBody$productDetail$ctl00$AddProductButton";
    console.log("[SFL] Using hardcoded Add to Cart event target:", eventTarget);
  }

  hidden["__EVENTTARGET"] = eventTarget;
  hidden["__EVENTARGUMENT"] = "";

  const fd = toFormData(hidden);
  const res = await fetch(pdpUrl, {
    method: "POST",
    credentials: "include",
    body: fd
  });

  if (!res.ok) throw new Error("Add to Cart postback failed.");
  console.log("[SFL] Add to Cart succeeded");
  return true;
}


async function removeQuicklistLine(productCodeToRemove) {
  const detailUrl = sessionStorage.getItem("sfl_detail_url");
  if (!detailUrl) throw new Error("Missing quicklist detail URL");

  console.log(`[SFL] Removing item from quicklist using detail URL: ${detailUrl}`);

  // 1. Load the quicklist page HTML
  const response = await fetch(detailUrl, { credentials: "include" });
  const html = await response.text();
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, "text/html");
  console.log("[SFL] Loaded quicklist detail page");

  // 2. Parse the grid rows and find the correct delete __EVENTTARGET
  const rows = doc.querySelectorAll("tr.rgRow, tr.rgAltRow");
  let eventTarget = null;

for (const tr of rows) {
  const deleteAnchor = tr.querySelector("a[id*='DeleteQuicklistLineButtonX']");
  const onclick = deleteAnchor?.getAttribute("onclick") || "";
  const productCodeMatch = onclick.match(/PromptDeleteQuicklistLine\("([^"]+)"/);
  const productCode = productCodeMatch?.[1]?.trim().toUpperCase();

  if (productCode === productCodeToRemove.toUpperCase()) {
    const href = deleteAnchor.getAttribute("href") || "";
    const match = href.match(/__doPostBack\('([^']+)'/);

    if (match) {
      eventTarget = match[1];
      console.log(`[SFL] Matched product '${productCodeToRemove}' — using eventTarget: ${eventTarget}`);
      break;
    }
  }
}



  if (!eventTarget) {
    console.error(`[SFL] Could not find delete button for product ${productCodeToRemove}`);
    throw new Error("Delete button not found in DOM.");
  }

  // 3. Build form data for POST
  const form = doc.querySelector("form");
  const inputs = [...form.querySelectorAll("input[type=hidden]")];
  const formData = new URLSearchParams();

  inputs.forEach(input => {
    if (input.name) formData.append(input.name, input.value);
  });

  formData.set("__EVENTTARGET", eventTarget);
  formData.set("__EVENTARGUMENT", "");

  const postUrl = new URL(form.getAttribute("action"), detailUrl).href;

  const postRes = await fetch(postUrl, {
    method: "POST",
    credentials: "include",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: formData.toString()
  });

  const resText = await postRes.text();
  if (!resText.includes("QuicklistDetailGrid")) {
    console.error("[SFL] Response text preview:\n", resText.slice(0, 500));
    throw new Error("Failed to remove item from Quicklist.");
  }

  console.log("[SFL] Item successfully removed from Quicklist.");
}














  async function refreshSfl() {
    // Re-run the loader from Phase 1
    const init = window.__sflReload;
    if (typeof init === "function") await init();
  }

  // Wire up the click handler
  document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".js-sfl-add");
  if (!btn) return;

  btn.disabled = true;
  btn.textContent = "Adding…";

  const row = btn.closest(".sflRow");
  const pid = row?.dataset?.pid || null;
  const productCode = row?.dataset?.code || null;

  try {
    if (!pid) throw new Error("Missing PID for add-to-cart.");

    // 1. Add to cart
    await addPidToCart(pid, 1);

    // 2. Remove from Quicklist using productCode
    if (productCode) {
      await removeQuicklistLine(productCode);
      console.log("[SFL] Removed item from Saved For Later list");
    } else {
      throw new Error("Missing productCode for removal.");
    }

    // 3. Refresh UI
    console.log("[SFL] Refreshing ShoppingCart page to show updated cart...");
    location.replace(location.href);

    await refreshSfl();
  } catch (err) {
    console.error("[SFL] Add to cart/remove failed:", err);
    btn.textContent = "Try Again";
    btn.disabled = false;
  }
});


  // Expose a hook Phase 1 can call to re-render
  window.__sflReload = async function() {
    const sflLoading = document.getElementById("sflLoading");
    if (sflLoading) sflLoading.style.display = "block";

    // Reload the detail list the same way Phase 1 did
    const detailUrl = sessionStorage.getItem("sfl_detail_url");
    if (!detailUrl) {
      location.reload();
      return;
    }
    const { text, doc } = await fetchHtml(detailUrl);
    const parse = (root) => {
      const grid = root.querySelector("#ctl00_PageBody_ctl01_QuicklistDetailGrid");
      if (!grid) return [];
      const table = grid.querySelector("table.rgMasterTable");
      if (!table) return [];
      const items = [];
      table.querySelectorAll("tbody > tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        if (tds.length < 5) return;
        const a = tds[0].querySelector("a[href*='ProductDetail.aspx']");
        const href = a ? a.getAttribute("href") : null;
        const code = a ? a.textContent.trim() : "";
        const desc = tds[1].textContent.trim();
        const price = tds[2].textContent.trim();
        const per = tds[3].textContent.trim();
        const delA = tds[4].querySelector("a[href^='javascript:__doPostBack']");
        let target = null;
        if (delA) {
          const h = delA.getAttribute("href") || "";
          const m = h.match(/__doPostBack\('([^']+)'/);
          if (m) target = m[1];
        }
        items.push({ productHref: href, productCode: code, description: desc, price, per, eventTarget: target });
      });
      return items;
    };
    const items = parse(doc);

    // Re-draw rows (reusing Phase 1’s render)
    const list = document.getElementById("sflList");
    if (!list) return;
    list.innerHTML = "";

    const hdrCount = document.getElementById("sflCount");
    const loading = document.getElementById("sflLoading");
    const empty = document.getElementById("sflEmpty");

    function pidFromHref(href) {
      try {
        const u = new URL(href, location.origin + "/");
        return u.searchParams.get("pid");
      } catch (e) { return null; }
    }
    function productImageUrlFromPid(pid) {
      return "https://images-woodsonlumber.sirv.com/Other%20Website%20Images/placeholder.png";
    }

    if (!items.length) {
      if (hdrCount) hdrCount.textContent = "(0)";
      if (loading) loading.style.display = "none";
      if (list) list.style.display = "none";
      if (empty) empty.style.display = "block";
      return;
    }

    items.forEach(item => {
      const pid = item.productHref ? pidFromHref(item.productHref) : null;
      const img = productImageUrlFromPid(pid);
      const row = document.createElement("div");
      row.className = "sflRow";
      row.dataset.eventTarget = item.eventTarget || "";
      row.dataset.pid = pid || "";
      row.dataset.code = item.productCode || "";
      row.innerHTML = `
        <img class="sflImg" src="${img}" alt="">
        <div>
          <div class="sflTitle">${item.productCode || ""}</div>
          <div class="sflDesc">${item.description || ""}</div>
        </div>
        <div class="sflPrice">${item.price || ""}</div>
        <div class="sflPer">${item.per || ""}</div>
        <div class="sflActions">
          <button class="sflBtn js-sfl-add" data-pid="${pid || ""}" data-code="${item.productCode || ""}">Add to Cart</button>
        </div>
      `;
      list.appendChild(row);
    });

    if (hdrCount) hdrCount.textContent = `(${items.length})`;
    if (loading) loading.style.display = "none";
    if (empty) empty.style.display = "none";
    if (list) list.style.display = "block";
  };
})();


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          (function(){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const BASE = location.origin + "/";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              async function fetchHtml(url, options = {}) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const res = await fetch(url, { credentials: "include", ...options });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const text = await res.text();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const doc = new DOMParser().parseFromString(text, "text/html");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return { text, doc };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      function getHiddenFields(doc) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const fields = {};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              doc.querySelectorAll('input[type="hidden"]').forEach(inp => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (inp.name) fields[inp.name] = inp.value || "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return fields;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                function toFormData(obj) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const fd = new FormData();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Object.entries(obj).forEach(([k, v]) => fd.append(k, v));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return fd;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Add a product to the SFL quicklist by posting back the PDP’s Quicklist menu item.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  async function addPidToSavedForLaterViaPdp(pid) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const url = BASE + "ProductDetail.aspx?pid=" + encodeURIComponent(pid);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const { doc } = await fetchHtml(url);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const hidden = getHiddenFields(doc);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // 1) Trigger the "Quicklist Options" opening if needed (some pages require a prep postback).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // If opening is client-side only, you can skip and directly target the specific "Saved For Later" menu item.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // 2) Find the menu item for "Saved For Later" in PDP markup.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Look for an <a href="javascript:__doPostBack('ctl00$...$QuicklistMenu$...','')">Saved For Later</a>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const menuItem = Array.from(doc.querySelectorAll('a[href^="javascript:__doPostBack"]'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        .find(a => a.textContent.trim().toLowerCase() === "saved for later");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (!menuItem) throw new Error("Could not locate 'Saved For Later' quicklist menu item on PDP.");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const href = menuItem.getAttribute("href");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const m = href.match(/__doPostBack\('([^']+)'/);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (!m) throw new Error("Could not parse Quicklist __EVENTTARGET.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const target = m[1];

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                hidden["__EVENTTARGET"] = target;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    hidden["__EVENTARGUMENT"] = "";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const fd = toFormData(hidden);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const res = await fetch(url, {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  method: "POST",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        credentials: "include",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              body: fd
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (!res.ok) throw new Error("Failed to add to Saved For Later via PDP.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Example wiring — you’ll replace the selector with your cart row buttons
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.addEventListener("click", async (e) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const btn = e.target.closest(".js-save-for-later-from-cart");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (!btn) return;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            btn.disabled = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                btn.textContent = "Saving…";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const row = btn.closest("[data-pid], [data-productcode]");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const pid = row?.dataset?.pid || btn.dataset.pid;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  await addPidToSavedForLaterViaPdp(pid);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Remove the line from cart (call your existing delete function or postback)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // deleteCartLine(row);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Optional: refresh SFL
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (typeof window.__sflReload === "function") await window.__sflReload();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                btn.textContent = "Saved";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } catch (err) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          console.error(err);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                btn.textContent = "Try Again";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      btn.disabled = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            })();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }, 2000);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            